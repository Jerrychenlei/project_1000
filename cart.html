<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=0">
	<title>购物车</title>
	<link rel="stylesheet" type="text/css" href="./css/cart.css" />
	<link rel="stylesheet" href="./lib/iconfont/iconfont.css">
</head>

<body>
	<div class="body">
		<div class="shop"><i class="iconfont icon-fanhui"></i><span>我的购物车</span></div>
		<div class="product">
			<!-- <div class="product-box">
				<div class="product-ckb">
					<em class="product-em product-xz"></em>
				</div>
				<div class="product-sx">
					<a href="###">
						<img src="img/a3.png" class="product-img" />
						<span class="product-name">酷冷至尊(Cooler Master)T610P CPU风冷散热器</span>
					</a>
					<span class="product-price">¥&thinsp;<span class="price">296</span></span>
					<div class="product-amount">
						<div class="product_gw">
							<em class="product-jian">-</em>
							<input type="text" value="1" class="product-num" />
							<em class="product-add">+</em>
						</div>
					</div>
					<div class="product-del">
						<span class="iconfont icon-shanchu"></span>
					</div>
				</div>
			</div>
			<div class="product-box">
				<div class="product-ckb"><em class="product-em"></em></div>
				<div class="product-sx">
					<a href="###">
						<img src="img/a1.png" class="product-img" />
						<span class="product-name">游戏悍将 35英寸曲面电竞显示器21:9带鱼屏准4K游戏显示器</span>
					</a>
					<span class="product-price">¥&thinsp;<span class="price">296</span></span>
					<div class="product-amount">
						<div class="product_gw">
							<em class="product-jian">-</em>
							<input type="text" value="1" class="product-num" />
							<em class="product-add">+</em>
						</div>
					</div>
					<div class="product-del">
						<span data-pid="15" class="iconfont icon-shanchu"></span>
					</div>
				</div>
			</div>

			<div class="product-box">
				<div class="product-ckb"><em class="product-em"></em></div>
				<div class="product-sx">
					<a href="###">
						<img src="img/a2.png" class="product-img" />
						<span class="product-name">技嘉（GIGABYTE） 2080TURBO OC 8GC</span>
					</a>
					<span class="product-price">¥&thinsp;<span class="price">296</span></span>
					<div class="product-amount">
						<div class="product_gw">
							<em class="product-jian">-</em>
							<input type="text" value="1" class="product-num" />
							<em class="product-add">+</em>
						</div>
					</div>
					<div class="product-del">
						<span class="iconfont icon-shanchu"></span>
					</div>
				</div>
			</div>

			<div class="product-box">
				<div class="product-ckb"><em class="product-em"></em></div>
				<div class="product-sx">
					<a href="###">
						<img src="img/a4.png" class="product-img" />
						<span class="product-name">AMD 锐龙 5 2600X 处理器 (R5) 6核12线程 AM4 </span>
					</a>
					<span class="product-price">¥&thinsp;<span class="price">296</span></span>
					<div class="product-amount">
						<div class="product_gw">
							<em class="product-jian">-</em>
							<input type="text" value="1" class="product-num" />
							<em class="product-add">+</em>
						</div>
					</div>
					<div class="product-del">
						<span class="iconfont icon-shanchu"></span>
					</div>
				</div>
			</div> -->
		</div>
		<div class="product-js">
			<div class="product-al">
				<div class="product-all">
					<em class=""></em>
				</div>
				<div class="all-xz"><span class="product-all-qx">全选</span>
					<div class="all-sl" style="display: none;">(<span class="product-all-sl">0</span>)</div>
				</div>
			</div>
			<a href="order.html" class="product-sett product-sett-a">结算</a>
			<div class="all-product"><span class="all-product-a">¥&thinsp;<span class="all-price">296</span></span>
			</div>

		</div>
	</div>
	<!--购物车空-->
	<div class="kon-cat">
		<div class="catkon">
			<div class="kon-box">
				<div class="kon-hz">
					<img src="img/cart-air.png" />
					<span class="kon-wz">购物车什么都没有</span>
					<a href="###" class="kon-lj">去逛逛</a>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="./lib/jquery.min.js"></script>
<script src="./lib/template-web.js"></script>
<script src="./js/cart.js" type="text/javascript" charset="utf-8"></script>

<script type="text/html" id="tpl-Cart">
	{{each data}}
	<div class="product-box">
		<div class="product-ckb">
			<em class="product-em product-xz"></em>
		</div>
		<div class="product-sx">
			<a href="###">
				<img src="{{$value.fileurl | imgUrl}}" class="product-img" />
				<span class="product-name">{{$value.name}}</span>
			</a>
			<span class="product-price">¥&thinsp;<span class="price">{{$value.price}}</span></span>
			<div class="product-amount">
				<div class="product_gw">
					<em class="product-jian" data-id="{{$value.id}}">-</em>
					<input type="text" value="{{$value.num}}" class="product-num" />
					<em class="product-add" data-id="{{$value.id}}">+</em>
				</div>
			</div>
			<div class="product-del" data-id="{{$value.id}}">
				<span class="iconfont icon-shanchu"></span>
			</div>
		</div>
	</div>
	{{/each}}
</script>
<script>
	// 节流阀
	let flag = false;
	// 获取用户token值
	let myToken = localStorage.getItem('token');
	// 商品总价
	let maxNum = 0;
	// 商品数量变量
	let addnum = 1;
	$(() => {
		// 模板引擎过滤器
		template.defaults.imports.imgUrl = function (fileurl) {
			return 'http://www.shop.com' + fileurl;
		}

		// 渲染购物车页面
		emptyCart();
		getCart();
		// // 删除按钮点击事件
		$('.product').on('click', '.product-del', getOutCart);
		// // 增加数量
		$('.product').on('click', '.product-add', addCommodity)
		// // 减少数量
		$('.product').on('click', '.product-jian', outCommodity);

	})
	// 查看购物车数据
	function getCart() {
		$.ajax({
			method: 'GET',
			url: 'http://www.shop.com/api/cart/getlist',
			data: { token: myToken },
			success(res) {
				console.log(res);
				let strHtml = template('tpl-Cart', res);
				$('.product').empty().html(strHtml);
				// debugger;
				if (res.data != []) {
					flag = true
				}
				totalPrice();
				count();
			}
		})
	}
	//购物车空
	function emptyCart() {
		console.log(flag);
		if (flag) {
			$(".all-price").text("0.00");
			$(".product-all-qx").text("全选");
			$(".all-sl").css("display", "none");
			$(".product-sett").addClass("product-sett-a");
			$(".product-all em").removeClass("product-all-on");
			$(".kon-cat").css("display", "block");
		} else {
			$(".kon-cat").css("display", "none");
		}
	}
	// 删除购物车功能--事件函数----
	function getOutCart() {
		let index = $(this).attr('data-id');
		$.ajax({
			method: 'GET',
			url: 'http://www.shop.com/api/cart/remove',
			data: {
				id: index,
				token: myToken
			},
			success(res) {
				console.log(res);
				if (res.code !== 2000) return alert('删除失败');
				getCart();
			}
		})
	}
	// 修改购物车功能--事件函数----
	function modifyCart(index, num) {

		$.ajax({
			method: 'GET',
			url: 'http://www.shop.com/api/cart/edit',
			data: {
				token: myToken,
				id: index,
				num: num
			},
			success(res) {
				getCart();
			}
		})
	}
	// 增加商品功能--事件函数----
	function addCommodity() {
		let addIndex = $(this).attr('data-id');
		let addnum = $(this).siblings('.product-num').val();
		addnum++;
		modifyCart(addIndex, addnum);
		$(this).siblings('.product-num').val(addnum);
	}
	// 减少商品功能--事件函数----
	function outCommodity() {
		let outIndex = $(this).attr('data-id');
		let outnum = $(this).siblings('.product-num').val();
		if (outnum > 1) {
			outnum--;
			modifyCart(outIndex, outnum);
			$(this).siblings('.product-num').val(outnum);
		}
		else {
			outnum = 1;
		}

	}
</script>

</html>